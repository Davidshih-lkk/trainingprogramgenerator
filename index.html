<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åŒ–äº¤æ˜“å›æ¸¬ç³»çµ± (Proç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; color: #334155; }
        
        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; transition: all 0.2s; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025); }
        
        /* æ¨™é¡Œæ¨£å¼ */
        .section-header { display: flex; align-items: center; gap: 0.5rem; padding: 1rem 1.5rem; border-bottom: 1px solid #f1f5f9; background-color: #f8fafc; border-radius: 12px 12px 0 0; }
        .section-title { font-weight: 700; color: #475569; font-size: 1.1rem; }
        .section-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: white; }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .input-group { margin-bottom: 1rem; }
        .input-label { display: block; font-size: 0.85rem; font-weight: 500; color: #64748b; margin-bottom: 0.25rem; }
        .input-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; transition: border-color 0.15s, box-shadow 0.15s; color: #1e293b; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-field:disabled { background-color: #f1f5f9; cursor: not-allowed; }
        
        /* æª”æ¡ˆä¸Šå‚³æ¨£å¼ */
        .file-drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; background-color: #f8fafc; }
        .file-drop-zone:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .file-drop-zone.loaded { border-color: #10b981; background-color: #f0fdf4; }
        .file-text { font-size: 0.9rem; color: #64748b; margin-top: 0.5rem; }
        .file-status { font-size: 0.8rem; font-weight: 600; margin-top: 0.25rem; }
        
        /* çµ±è¨ˆå¡ç‰‡ */
        .stat-card { background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #e2e8f0; text-align: center; }
        .stat-label { font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.75rem; font-weight: 800; color: #1e293b; margin-top: 0.25rem; }
        
        /* é¡è‰²ä¸»é¡Œ */
        .theme-blue { background-color: #3b82f6; }
        .theme-indigo { background-color: #6366f1; }
        .theme-emerald { background-color: #10b981; }
        .theme-rose { background-color: #f43f5e; }
        .text-theme-emerald { color: #059669; }
        .text-theme-rose { color: #e11d48; }

        /* æŒ‰éˆ•ç‰¹æ•ˆ */
        .btn-run { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 50px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .btn-run:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.4); }
        .btn-run:active:not(:disabled) { transform: translateY(0); }
        .btn-run:disabled { background: #94a3b8; cursor: not-allowed; box-shadow: none; }
        
        /* Loading Overlay */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    </style>
</head>
<body class="p-4 md:p-8 max-w-[1600px] mx-auto">

    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-blue-600"></i>
                é‡åŒ–äº¤æ˜“ç­–ç•¥å›æ¸¬ç³»çµ± <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full ml-2">Pro</span>
            </h1>
            <p class="text-slate-500 text-sm mt-1">åŸºæ–¼å¤šå› å­æ–œç‡èˆ‡å‹•æ…‹æ¿¾ç¶²çš„æœŸè²¨å›æ¸¬æ¨¡å‹</p>
        </div>
        <div>
            <button id="run-backtest-btn" class="btn-run flex items-center gap-2" disabled>
                <i class="fa-solid fa-play"></i> åŸ·è¡Œå›æ¸¬åˆ†æ
            </button>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-12 gap-6">

        <!-- Left Column: Settings -->
        <div class="col-span-12 xl:col-span-4 space-y-6">
            
            <!-- 1. Data Upload -->
            <div class="card">
                <div class="section-header">
                    <div class="section-icon theme-blue"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                    <div class="section-title">æ•¸æ“šä¾†æº</div>
                </div>
                <div class="p-6 space-y-4">
                    <!-- File 1 -->
                    <div>
                        <label for="hDF-upload" class="hidden"></label>
                        <div class="file-drop-zone" id="zone-hDF" onclick="document.getElementById('hDF-upload').click()">
                            <i class="fa-solid fa-file-csv text-2xl text-slate-400"></i>
                            <div class="file-text">NQ 1Hr Kç·šæ•¸æ“š (ä¸»æ•¸æ“š)</div>
                            <div class="file-status text-slate-400" id="hDF-status">æœªé¸æ“‡æª”æ¡ˆ</div>
                        </div>
                        <input type="file" id="hDF-upload" class="hidden" accept=".csv">
                    </div>
                    <!-- File 2 -->
                    <div>
                        <div class="file-drop-zone" id="zone-fDF" onclick="document.getElementById('fDF-upload').click()">
                            <i class="fa-solid fa-table-list text-2xl text-slate-400"></i>
                            <div class="file-text">å› å­æ•¸æ“š (å°è‚¡ç±Œç¢¼/æ—¥)</div>
                            <div class="file-status text-slate-400" id="fDF-status">æœªé¸æ“‡æª”æ¡ˆ</div>
                        </div>
                        <input type="file" id="fDF-upload" class="hidden" accept=".csv">
                    </div>
                    <!-- File 3 -->
                    <div>
                        <div class="file-drop-zone" id="zone-nqdDF" onclick="document.getElementById('nqdDF-upload').click()">
                            <i class="fa-solid fa-calendar-days text-2xl text-slate-400"></i>
                            <div class="file-text">NQ æ—¥Kç·šæ•¸æ“š (è¶¨å‹¢æ¿¾ç¶²)</div>
                            <div class="file-status text-slate-400" id="nqdDF-status">æœªé¸æ“‡æª”æ¡ˆ</div>
                        </div>
                        <input type="file" id="nqdDF-upload" class="hidden" accept=".csv">
                    </div>
                </div>
            </div>

            <!-- 2. Capital & Contract -->
            <div class="card">
                <div class="section-header">
                    <div class="section-icon theme-indigo"><i class="fa-solid fa-coins"></i></div>
                    <div class="section-title">åˆç´„èˆ‡è³‡é‡‘åƒæ•¸</div>
                </div>
                <div class="p-6 grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="input-label">èµ·å§‹è³‡é‡‘ (USD)</label>
                        <input type="number" id="money0" value="12210" class="input-field font-mono">
                    </div>
                    <div class="input-group">
                        <label class="input-label">åˆç´„è¦æ ¼ (é»å€¼)</label>
                        <input type="number" id="contract_value" value="2" class="input-field font-mono">
                    </div>
                    <div class="input-group">
                        <label class="input-label">æ¯å£ä¿è­‰é‡‘</label>
                        <input type="number" id="F_unit" value="2442" class="input-field font-mono">
                    </div>
                    <div class="input-group">
                        <label class="input-label">å®‰å…¨é‚Šéš›ä¿‚æ•¸</label>
                        <input type="number" id="safetymargin" value="1.9" step="0.1" class="input-field font-mono">
                    </div>
                </div>
            </div>

            <!-- 3. Entry Signals -->
            <div class="card">
                <div class="section-header">
                    <div class="section-icon theme-emerald"><i class="fa-solid fa-arrow-right-to-bracket"></i></div>
                    <div class="section-title">é€²å ´è¨Šè™Ÿè¨­å®š</div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="input-label">é¸æ“‡æ¬Šæ–œç‡å¤©æ•¸</label>
                            <input type="number" id="option_slope" value="13" class="input-field">
                        </div>
                        <div class="input-group">
                            <label class="input-label">æ–œç‡é–€æª» (OP_S_S)</label>
                            <input type="number" id="OP_S_S" value="5000" class="input-field">
                        </div>
                        <div class="input-group">
                            <label class="input-label">æœªå¹³å€‰æ–œç‡å¤©æ•¸</label>
                            <input type="number" id="OI_slope" value="23" class="input-field">
                        </div>
                        <div class="input-group opacity-50">
                            <label class="input-label">æœªæ²–éŠ·æ–œç‡ (æœªä½¿ç”¨)</label>
                            <input type="number" id="unapplied_slope" value="23" class="input-field" disabled>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Exit & Filters -->
            <div class="card">
                <div class="section-header">
                    <div class="section-icon theme-rose"><i class="fa-solid fa-filter"></i></div>
                    <div class="section-title">å‡ºå ´èˆ‡æ¿¾ç¶²è¨­å®š</div>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group col-span-2">
                            <label class="input-label">å•Ÿç”¨ CS å‡ç·šéæ¿¾</label>
                            <select id="CS" class="input-field">
                                <option value="True">å•Ÿç”¨ (True)</option>
                                <option value="False">åœç”¨ (False)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">CS æ¿¾ç¶²é€±æœŸ</label>
                            <input type="number" id="CSL" value="11" class="input-field">
                        </div>
                        <div class="input-group">
                            <label class="input-label">NQ æ—¥Kå‡ç·šé€±æœŸ</label>
                            <input type="number" id="NQsma" value="13" class="input-field">
                        </div>
                    </div>
                    
                    <div class="border-t border-slate-100 pt-4 mt-2">
                        <label class="input-label mb-2 text-slate-800">åœææ¢ä»¶è¨­å®š (%)</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">åº•éƒ¨åœæ</label>
                                <input type="number" id="stop_loss" value="11" class="input-field text-center">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">æœ€å¤§å›æ’¤</label>
                                <input type="number" id="high_stop_loss" value="9" class="input-field text-center">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">å‡ç·šè·Œç ´</label>
                                <input type="number" id="downp" value="7" class="input-field text-center">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Column: Results -->
        <div class="col-span-12 xl:col-span-8 space-y-6">
            
            <!-- Stats Row -->
            <div id="stats-output" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                <div class="stat-card border-l-4 border-l-emerald-500">
                    <div class="stat-label">ç¸½å ±é…¬ç‡ (Total Return)</div>
                    <div class="stat-value text-theme-emerald" id="stat-total-return">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€çµ‚å¸³æˆ¶åƒ¹å€¼ (Final)</div>
                    <div class="stat-value" id="stat-final-value">-</div>
                </div>
                <div class="stat-card border-l-4 border-l-rose-500">
                    <div class="stat-label">æœ€å¤§å›æ’¤ (Max Drawdown)</div>
                    <div class="stat-value text-theme-rose" id="stat-max-drawdown">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç¸½äº¤æ˜“æ¬¡æ•¸ (Count)</div>
                    <div class="stat-value" id="stat-trade-count">-</div>
                </div>
            </div>

            <!-- Chart -->
            <div id="chart-output" class="card p-4 hidden h-[600px]">
                <div id="equity-chart" class="w-full h-full"></div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="card p-12 text-center text-slate-400 h-[400px] flex flex-col items-center justify-center">
                <i class="fa-solid fa-chart-area text-6xl mb-4 opacity-20"></i>
                <p class="text-lg">è«‹ä¸Šå‚³æ•¸æ“šæª”æ¡ˆä¸¦é»æ“Šã€ŒåŸ·è¡Œå›æ¸¬ã€ä»¥æŸ¥çœ‹çµæœ</p>
            </div>

        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <div class="text-lg font-bold text-slate-700">æ­£åœ¨åŸ·è¡Œå›æ¸¬é‹ç®—...</div>
            <div class="text-sm text-slate-500 mt-2">è™•ç†é¾å¤§æ•¸æ“šä¸­ï¼Œè«‹ç¨å€™</div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl">
            <h3 class="text-lg font-bold text-red-600 mb-2"><i class="fa-solid fa-triangle-exclamation mr-2"></i>éŒ¯èª¤</h3>
            <p id="error-msg" class="text-slate-600 mb-6 text-sm"></p>
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded transition">
                é—œé–‰
            </button>
        </div>
    </div>

    <script>
        // --- Core Logic & Helpers ---

        const parseCSV = (text) => {
            const lines = text.trim().split('\n');
            if (lines.length < 1) return null;
            const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            return lines.slice(1).filter(l => l.trim()).map(line => {
                const values = line.split(',');
                const row = {};
                header.forEach((key, i) => {
                    let val = values[i] ? values[i].trim().replace(/"/g, '') : '';
                    row[key] = (val !== '' && !isNaN(Number(val))) ? Number(val) : val;
                });
                return row;
            });
        };

        const calculateSlope = (data, period) => {
            if (!data || data.length !== period) return NaN;
            let n = period;
            let x = Array.from({length: n}, (_, i) => i);
            let y = data;
            
            // Validate data
            if (y.some(val => typeof val !== 'number' || isNaN(val))) return NaN;

            let meanX = x.reduce((a, b) => a + b) / n;
            let meanY = y.reduce((a, b) => a + b) / n;
            let num = 0, den = 0;
            for(let i=0; i<n; i++) {
                num += (x[i] - meanX) * (y[i] - meanY);
                den += (x[i] - meanX) ** 2;
            }
            return den === 0 ? NaN : num / den;
        };

        const calculateSMA = (data, period) => {
            let sma = new Array(data.length).fill(NaN);
            let sum = 0;
            for(let i=0; i<data.length; i++) {
                if (typeof data[i] !== 'number' || isNaN(data[i])) {
                    // Reset if data is invalid, simple handling
                    sum = 0; 
                    continue; 
                }
                sum += data[i];
                if(i >= period) sum -= data[i-period];
                if(i >= period-1) sma[i] = sum/period;
            }
            return sma;
        };

        // --- Backtest Engine ---

        function runBacktest(DF, fDF, nqdDF, params) {
            console.log("ğŸš€ Starting Backtest...", params);

            // 1. Preprocess Factor Data (Daily)
            const fDFProcessed = fDF.map(row => ({...row}));
            
            // Extract numeric arrays for vectorized-like operations
            const getCol = (name) => fDFProcessed.map(r => Number(r[name]) || 0);
            const op_data = getCol("è‡ºæŒ‡é¸æ“‡æ¬Š_è²·æ¬Š_å¤–è³‡_æœªå¹³å€‰é¤˜é¡_è²·è³£å·®é¡_å¥‘ç´„é‡‘é¡");
            const oi_data = getCol("è‡ºè‚¡æœŸè²¨_ç¸½æœªå¹³å€‰é¤˜é¡å¤šç©ºæ·¨é¡");
            const financing = getCol("èè³‡ç¶­æŒç‡");

            // 1.1 Calculate Slopes & Indicators
            for(let i=0; i<fDFProcessed.length; i++) {
                // Option Slope
                if(i >= params.option_slope - 1) {
                    let window = op_data.slice(i - params.option_slope + 1, i + 1);
                    fDFProcessed[i].op_slope = calculateSlope(window, params.option_slope);
                } else { fDFProcessed[i].op_slope = NaN; }

                // OI Slope
                if(i >= params.OI_slope - 1) {
                    let window = oi_data.slice(i - params.OI_slope + 1, i + 1);
                    fDFProcessed[i].oi_slope = calculateSlope(window, params.OI_slope);
                } else { fDFProcessed[i].oi_slope = NaN; }
            }

            // 1.2 CS Filter Logic
            if(params.CS) {
                // Find min to normalize
                const validOps = op_data.filter(n => !isNaN(n));
                const minOp = validOps.length ? Math.min(...validOps) : 0;
                const normalOp = op_data.map(n => n + Math.abs(minOp));
                const smaOp = calculateSMA(normalOp, params.CSL);
                
                for(let i=0; i<fDFProcessed.length; i++) {
                    fDFProcessed[i].CS_OP = (!isNaN(normalOp[i]) && !isNaN(smaOp[i]) && normalOp[i] > smaOp[i]) ? 1 : 0;
                }
            } else {
                fDFProcessed[i].CS_OP = 1; // Default Pass
            }

            // 1.3 NQ Daily Filter
            // Map Date -> Previous Day's SMA Condition
            // Warning: nqdDF data row "2023-01-01" contains Close of that day.
            // At 09:00 on 2023-01-01, we only know "2022-12-31" data.
            // Logic: Calculate SMA on nqdDF. 
            // Create a Set of "Allowed Dates". If nqdDF[i] satisfies condition, then nqdDF[i+1].Date is allowed.
            
            const nqdClose = nqdDF.map(r => Number(r["Close"])||0);
            const nqdSMA = calculateSMA(nqdClose, params.NQsma);
            const allowedDays = new Set();
            const daySmaMap = new Map(); // Date -> SMA of previous day (for stop loss logic)

            if(params.NQsma > 0) {
                for(let i=0; i<nqdDF.length-1; i++) {
                    if(!isNaN(nqdClose[i]) && !isNaN(nqdSMA[i])) {
                        // Store SMA for next day usage
                        let nextDayDate = nqdDF[i+1]["æ—¥æœŸ"];
                        daySmaMap.set(nextDayDate, nqdSMA[i]);

                        // Entry Condition check
                        if(nqdClose[i] > nqdSMA[i]) {
                            allowedDays.add(nextDayDate);
                        }
                    }
                }
            }

            // 1.4 Generate Daily Signals
            const dailySignals = new Map();
            for(let i=0; i<fDFProcessed.length; i++) {
                const r = fDFProcessed[i];
                const s1 = (r.op_slope > params.OP_S_S && r.CS_OP === 1) ? 1 : 0;
                const s2 = (r.oi_slope > 0) ? 1 : 0;
                const s4 = (financing[i] < 160 && financing[i] > 0) ? 1 : 0;
                dailySignals.set(r["æ—¥æœŸ"], {s1, s2, s4});
            }

            // 2. Hourly Loop Simulation
            const hrClose = DF.map(r => Number(r["Close"])||0);
            const sma400 = calculateSMA(hrClose, 400); // 400hr SMA
            
            let record = {
                money: params.money0,
                hold: [], // Array of entry prices
                history: { time: [], equity: [] },
                tradeCount: 0
            };

            const sl_ratio = params.stop_loss / 100;
            const hs_ratio = params.high_stop_loss / 100;
            const down_ratio = params.downp / 100;

            // Loop start from 460 to ensure MA is ready
            for(let i=460; i<DF.length; i++) {
                const cur = DF[i];
                const prev = DF[i-1];
                const date = cur["Time"].split(" ")[0]; // YYYY-MM-DD
                const time = cur["Time"].split(" ")[1]; // HH:MM:SS
                
                // --- Exit Logic ---
                // Calculate Stop Prices
                
                // 1. Previous Day 09:00 Open
                let lastOpen = 0;
                for(let k=1; k<60; k++) {
                    if(i-k >= 0) {
                        let t = DF[i-k]["Time"];
                        if(t.split(" ")[0] !== date && t.split(" ")[1] === "09:00:00") {
                            lastOpen = DF[i-k]["Open"];
                            break;
                        }
                    }
                }
                const priceSL = lastOpen * (1 - sl_ratio);

                // 2. High Stop (Max Drawdown from Peak)
                // Optimization: Instead of loop 460 every time, we could track max. 
                // But for JS loop < 100k, inner loop 460 is acceptable.
                let maxHigh = 0;
                for(let k=i-460; k<i; k++) if(DF[k].High > maxHigh) maxHigh = DF[k].High;
                const priceHS = maxHigh * (1 - hs_ratio);

                // 3. MA Stop
                const prevDaySMA = daySmaMap.get(date) || 0;
                const priceMA = prevDaySMA > 0 ? prevDaySMA * (1 - down_ratio) : 0;

                // Combined Stop Logic: Trigger if Close < Max(SL, HS) OR Close < MA_Stop
                const hardStop = Math.max(priceSL, priceHS);
                const isStop = (prev.Close < hardStop) || (prevDaySMA > 0 && prev.Close < priceMA);

                // Execute Exit
                if(record.hold.length > 0 && isStop) {
                    let profit = 0;
                    let exitP = cur.Open; // Exit at Open
                    record.hold.forEach(entryP => {
                        profit += (exitP - entryP) * params.contract_value - 1.25; // fee
                    });
                    record.money += profit;
                    record.hold = [];
                }

                // --- Entry Logic ---
                let buySignal = 0;
                // Hourly Trend Filter
                const isHrTrend = prev.Close > sma400[i-1];
                
                if(time === "06:00:00" && isHrTrend) {
                    const ds = dailySignals.get(date);
                    // Check Day Filter (NQsma)
                    const isDayAllowed = (params.NQsma === 0) || allowedDays.has(date);
                    
                    if(ds && isDayAllowed) {
                        if(ds.s1) buySignal++;
                        if(ds.s2) buySignal++;
                        if(ds.s4) buySignal++;
                    }
                }

                if(buySignal > 0) {
                    const cost = params.F_unit * params.safetymargin;
                    // Buy Logic
                    for(let b=0; b<buySignal; b++) {
                        if(record.money > (record.hold.length + 1) * cost) {
                            record.hold.push(cur.Open);
                            record.tradeCount++;
                        }
                    }
                }

                // --- Record Keeping ---
                // Mark to Market
                let floatPnl = 0;
                if(record.hold.length > 0) {
                    record.hold.forEach(entryP => {
                        floatPnl += (cur.Close - entryP) * params.contract_value - 1.25;
                    });
                }
                let equity = record.money + floatPnl;
                
                // Store daily or hourly? Storing hourly for chart smoothness, 
                // but usually daily is enough. Let's do Daily Close to reduce array size for Plotly.
                // Or simply every bar if performance allows. Let's do every bar for now.
                // Optimization: Store only when date changes (Daily Close)
                if(i === DF.length-1 || date !== DF[i+1]["Time"].split(" ")[0]) {
                    record.history.time.push(date);
                    record.history.equity.push(equity);
                }
            }
            
            return record;
        }

        // --- UI Interaction ---

        let loadedData = { hDF: null, fDF: null, nqdDF: null };

        const handleFile = (type, input) => {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = parseCSV(e.target.result);
                if(data) {
                    loadedData[type] = data;
                    const zone = document.getElementById(`zone-${type}`);
                    const status = document.getElementById(`${type}-status`);
                    
                    zone.classList.add('loaded');
                    zone.querySelector('i').classList.replace('text-slate-400', 'text-emerald-500');
                    status.textContent = `å·²è¼‰å…¥ ${data.length.toLocaleString()} ç­†æ•¸æ“š`;
                    status.classList.replace('text-slate-400', 'text-emerald-600');
                    
                    checkReady();
                }
            };
            reader.readAsText(file);
        };

        const checkReady = () => {
            const btn = document.getElementById('run-backtest-btn');
            if(loadedData.hDF && loadedData.fDF && loadedData.nqdDF) {
                btn.disabled = false;
            }
        };

        const getParams = () => ({
            option_slope: parseInt(document.getElementById('option_slope').value),
            OP_S_S: parseFloat(document.getElementById('OP_S_S').value),
            OI_slope: parseInt(document.getElementById('OI_slope').value),
            CS: document.getElementById('CS').value === "True",
            CSL: parseInt(document.getElementById('CSL').value),
            NQsma: parseInt(document.getElementById('NQsma').value),
            stop_loss: parseFloat(document.getElementById('stop_loss').value),
            high_stop_loss: parseFloat(document.getElementById('high_stop_loss').value),
            downp: parseFloat(document.getElementById('downp').value),
            money0: parseFloat(document.getElementById('money0').value),
            F_unit: parseFloat(document.getElementById('F_unit').value),
            safetymargin: parseFloat(document.getElementById('safetymargin').value),
            contract_value: parseFloat(document.getElementById('contract_value').value)
        });

        document.getElementById('run-backtest-btn').addEventListener('click', () => {
            const btn = document.getElementById('run-backtest-btn');
            const overlay = document.getElementById('loading-overlay');
            
            btn.disabled = true;
            overlay.style.display = 'flex';

            // Allow UI to update before heavy calc
            setTimeout(() => {
                try {
                    const params = getParams();
                    const result = runBacktest(loadedData.hDF, loadedData.fDF, loadedData.nqdDF, params);
                    
                    displayResults(result, params.money0);
                } catch (err) {
                    console.error(err);
                    document.getElementById('error-msg').textContent = "åŸ·è¡Œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: " + err.message;
                    document.getElementById('error-modal').classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    overlay.style.display = 'none';
                }
            }, 100);
        });

        function displayResults(record, initialMoney) {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('stats-output').classList.remove('hidden');
            document.getElementById('chart-output').classList.remove('hidden');
            
            const history = record.history;
            const finalVal = history.equity[history.equity.length-1];
            const ret = ((finalVal - initialMoney)/initialMoney * 100).toFixed(2);
            
            // Calc MDD
            let peak = -Infinity;
            let mdd = 0;
            for(let v of history.equity) {
                if(v > peak) peak = v;
                let dd = (peak - v) / peak;
                if(dd > mdd) mdd = dd;
            }

            // Update UI
            const setVal = (id, val, colorClass) => {
                const el = document.getElementById(id);
                el.textContent = val;
                if(colorClass) el.className = `stat-value ${colorClass}`;
            };

            setVal('stat-total-return', ret + '%', ret >= 0 ? 'text-theme-emerald' : 'text-theme-rose');
            setVal('stat-final-value', Math.round(finalVal).toLocaleString(), '');
            setVal('stat-max-drawdown', (mdd*100).toFixed(2) + '%', 'text-theme-rose');
            setVal('stat-trade-count', record.tradeCount, '');

            // Plotly
            Plotly.purge('equity-chart');
            const trace = {
                x: history.time,
                y: history.equity,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#3b82f6', width: 2 },
                fill: 'tozeroy',
                fillcolor: 'rgba(59, 130, 246, 0.05)'
            };
            
            const layout = {
                title: 'å¸³æˆ¶æ¬Šç›Šæ›²ç·š (Daily Close)',
                margin: { t: 40, r: 20, l: 60, b: 40 },
                xaxis: { showgrid: false },
                yaxis: { title: 'Equity (USD)', gridcolor: '#f1f5f9' },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('equity-chart', [trace], layout, { responsive: true });
        }

        // Event Listeners for File Inputs
        ['hDF', 'fDF', 'nqdDF'].forEach(type => {
            document.getElementById(`${type}-upload`).addEventListener('change', function() {
                handleFile(type, this);
            });
        });

    </script>
</body>
</html>
