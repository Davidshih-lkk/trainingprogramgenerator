<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±è¹²ç”Ÿç‰©åŠ›å­¸æ¨¡æ“¬å™¨ (3D å°ˆæ¥­æ•™å­¸ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        canvas { touch-action: none; cursor: move; }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">


    <div class="w-full max-w-7xl bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex flex-col lg:flex-row">
        
        <!-- è¦–è¦ºåŒ–å€åŸŸ -->
        <div class="relative w-full lg:w-3/4 h-[600px] lg:h-[800px] bg-gray-950 border-r border-gray-700">
            <canvas id="simCanvas" class="w-full h-full block"></canvas>
            
            <!-- å·¦ä¸Šï¼š2D æ•¸æ“š -->
            <div class="absolute top-4 left-4 bg-gray-800/90 backdrop-blur p-3 rounded border border-gray-600 text-sm shadow-lg pointer-events-none">
                <div class="font-bold text-gray-400 border-b border-gray-600 pb-1 mb-2">2D å´é¢åƒæ•¸</div>
                <div class="grid grid-cols-1 gap-1">
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-500"></span> <span>è»€å¹¹å‰å‚¾: <strong id="torsoAngleDisplay">0Â°</strong></span></div>
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> <span>é«–è§’: <strong id="hipAngleDisplay">180Â°</strong></span></div>
                </div>
            </div>


            <!-- å³ä¸Šï¼š3D æ•¸æ“š -->
            <div class="absolute top-4 right-4 bg-gray-800/90 backdrop-blur p-3 rounded border border-gray-600 text-sm shadow-lg pointer-events-none text-right">
                <div class="font-bold text-gray-400 border-b border-gray-600 pb-1 mb-2">3D éª¨ç›†èˆ‡è„Šæ¤</div>
                <div class="grid grid-cols-1 gap-1 justify-items-end">
                    <div class="text-pink-400 font-bold" id="pelvisStatus3D">ä¸­ç«‹ä½</div>
                    <div class="text-[10px] text-gray-500">æ‹–æ›³ç•«é¢å¯æ—‹è½‰è¦–è§’</div>
                </div>
            </div>


            <!-- æˆªåœ–æŒ‰éˆ• (æ–°åŠŸèƒ½) -->
            <button onclick="saveSnapshot()" class="absolute bottom-4 right-4 bg-gray-700 hover:bg-gray-600 text-white text-xs px-3 py-2 rounded-lg border border-gray-500 shadow-lg transition flex items-center gap-2">
                ğŸ“¸ ä¸‹è¼‰æˆªåœ–
            </button>
        </div>


        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="w-full lg:w-1/4 p-5 flex flex-col gap-4 overflow-y-auto h-[600px] lg:h-[800px] bg-gray-800 scrollbar-thin scrollbar-thumb-gray-600">
            
            <div class="border-b border-gray-700 pb-2 flex justify-between items-end">
                <div>
                    <h2 class="text-lg font-bold text-emerald-400 mb-1">3D éª¨ç›†å¯¦é©—å®¤ v8.1</h2>
                    <p class="text-[10px] text-gray-400">å–®æ©Ÿé›¢ç·šç‰ˆ</p>
                </div>
            </div>


            <!-- 1. æ·±è¹²æ·±åº¦ -->
            <div class="bg-gray-700/40 p-3 rounded-lg border border-gray-600">
                <label class="block text-sm font-bold mb-2 flex justify-between">
                    <span>æ·±è¹²æ·±åº¦ (Depth)</span>
                    <span class="text-emerald-400" id="depthVal">0%</span>
                </label>
                <input type="range" id="squatDepth" min="0" max="100" value="0" class="w-full bg-gray-600 h-1 rounded-lg appearance-none accent-emerald-500">
            </div>


            <!-- 2. éª¨ç›†ä¸‰å¹³é¢æ§åˆ¶ -->
            <div class="bg-pink-900/10 p-3 rounded-lg border border-pink-900/30 space-y-4">
                <div class="flex justify-between items-center border-b border-pink-900/30 pb-1">
                    <label class="block text-sm font-bold text-pink-300">ğŸ¦´ éª¨ç›† 3D æ§åˆ¶</label>
                    <button id="resetPelvis" class="text-[10px] bg-gray-700 px-2 py-1 rounded hover:bg-gray-600 transition">æ­¸é›¶</button>
                </div>


                <!-- Sagittal -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>å¾Œå‚¾ (Posterior)</span>
                        <span>å‰å‚¾ (Anterior)</span>
                    </div>
                    <input type="range" id="pelvisTilt" min="-30" max="30" value="0" class="w-full bg-gray-600 h-1 rounded-lg appearance-none accent-pink-500">
                    <div class="text-[10px] text-center text-gray-500">å½±éŸ¿ï¼šè…°æ¤æ›²åº¦ (Lordosis)</div>
                </div>


                <!-- Frontal -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>å·¦æ (L Hike)</span>
                        <span>å³æ (R Hike)</span>
                    </div>
                    <input type="range" id="pelvisHike" min="-15" max="15" value="0" class="w-full bg-gray-600 h-1 rounded-lg appearance-none accent-blue-400">
                    <div class="text-[10px] text-center text-gray-500">å½±éŸ¿ï¼šè„Šæ¤å´å½ (Scoliosis)</div>
                </div>


                <!-- Transverse -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>å·¦æ—‹ (L Rot)</span>
                        <span>å³æ—‹ (R Rot)</span>
                    </div>
                    <input type="range" id="pelvisRot" min="-20" max="20" value="0" class="w-full bg-gray-600 h-1 rounded-lg appearance-none accent-orange-400">
                    <div class="text-[10px] text-center text-gray-500">å½±éŸ¿ï¼šè„Šæ¤æ‰­è½‰ (Torsion)</div>
                </div>
            </div>


            <!-- 3. ä¸‹è‚¢åƒæ•¸ -->
            <div class="bg-teal-900/20 p-3 rounded-lg border border-teal-900/30">
                 <label class="block text-xs font-bold text-teal-300 mb-2">ä¸‹è‚¢åƒæ•¸</label>
                 <div class="mb-2">
                    <label class="block text-[10px] mb-1 flex justify-between"><span>ç«™è·</span><span id="stanceVal">40</span></label>
                    <input type="range" id="stanceWidth" min="20" max="60" value="40" class="w-full bg-gray-600 h-1 rounded-lg appearance-none accent-teal-500">
                 </div>
                 <div>
                    <label class="block text-[10px] mb-1 flex justify-between"><span>è¶³èƒŒå¤–é–‹</span><span id="toeOutVal">15Â°</span></label>
                    <input type="range" id="toeOutAngle" min="0" max="45" value="15" class="w-full bg-gray-600 h-1 rounded-lg appearance-none accent-orange-500">
                 </div>
            </div>


            <!-- 4. ä»£å„Ÿæƒ…å¢ƒ -->
            <div class="bg-red-900/10 p-3 rounded-lg border border-red-900/30">
                <label class="block text-xs font-bold text-red-300 mb-1">ä»£å„Ÿæƒ…å¢ƒ</label>
                <select id="scenarioSelect" class="w-full bg-gray-700 border border-gray-600 text-white text-xs rounded p-2 focus:ring-red-500">
                    <option value="none">ğŸŸ¢ æ­£å¸¸ä¸­ç«‹ä½</option>
                    <option value="apt">âš ï¸ éª¨ç›†å‰å‚¾ (ä¸‹äº¤å‰)</option>
                    <option value="shift">âš ï¸ éª¨ç›†å´ç§» (é•·çŸ­è…³ä»£å„Ÿ)</option>
                    <option value="twist">âš ï¸ éª¨ç›†æ—‹è½‰ (æ ¸å¿ƒå¤±è¡¡)</option>
                    <option value="butt_wink">ğŸ”´ å±è‚¡çœ¨çœ¼ (æ·±è¹²å‹•æ…‹)</option>
                </select>
            </div>
            
            <div class="mt-auto border-t border-gray-700 pt-2">
                <p id="analysisText" class="text-xs text-gray-300 leading-relaxed">
                    ç³»çµ±å°±ç·’ã€‚èª¿æ•´æ»‘æ¡¿è§€å¯Ÿ 3D éª¨ç›†èˆ‡è„Šæ¤çš„é€£å‹•åæ‡‰ã€‚
                </p>
            </div>
        </div>
    </div>


    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- Controls ---
        const els = {
            depth: document.getElementById('squatDepth'),
            tilt: document.getElementById('pelvisTilt'),
            hike: document.getElementById('pelvisHike'),
            rot: document.getElementById('pelvisRot'),
            stance: document.getElementById('stanceWidth'),
            toeOut: document.getElementById('toeOutAngle'),
            scenario: document.getElementById('scenarioSelect'),
            resetPelvis: document.getElementById('resetPelvis')
        };
        
        const displays = {
            depth: document.getElementById('depthVal'),
            torso: document.getElementById('torsoAngleDisplay'),
            hip: document.getElementById('hipAngleDisplay'),
            pStatus: document.getElementById('pelvisStatus3D'),
            stance: document.getElementById('stanceVal'),
            toeOut: document.getElementById('toeOutVal'),
            analysis: document.getElementById('analysisText')
        };


        let state = {
            depth: 0, 
            tilt: 0, hike: 0, rot: 0,
            stance: 40, toeOut: 15,
            cameraAngle: { x: 0, y: -10 },
            isDragging: false,
            lastMouse: { x: 0, y: 0 },
            scenario: 'none'
        };


        const BONE_LENS = {
            femur: 110, tibia: 100, torso: 140, neck: 15
        };


        // --- 3D MATH UTILS ---
        function rotateX(p, angle) {
            const rad = angle * Math.PI / 180;
            const c = Math.cos(rad), s = Math.sin(rad);
            return { x: p.x, y: p.y * c - p.z * s, z: p.y * s + p.z * c };
        }
        function rotateY(p, angle) {
            const rad = angle * Math.PI / 180;
            const c = Math.cos(rad), s = Math.sin(rad);
            return { x: p.x * c + p.z * s, y: p.y, z: -p.x * s + p.z * c };
        }
        function rotateZ(p, angle) {
            const rad = angle * Math.PI / 180;
            const c = Math.cos(rad), s = Math.sin(rad);
            return { x: p.x * c - p.y * s, y: p.x * s + p.y * c, z: p.z };
        }
        function translate(p, v) { return { x: p.x + v.x, y: p.y + v.y, z: p.z + v.z }; }


        // --- 3D PELVIS GEOMETRY (REALISTIC) ---
        function getRealisticPelvisGeo() {
            const w = 35; 
            const h = 30; 
            return {
                sacrum_base: { x: 0, y: 0, z: 0 },
                sacrum_tip: { x: 0, y: -15, z: -5 },
                l_iliac_crest_post: { x: -w*0.4, y: 10, z: -5 }, 
                l_iliac_crest_lat:  { x: -w, y: 8, z: 5 },       
                l_asis:             { x: -w*0.7, y: 0, z: 15 },  
                l_acetabulum:       { x: -w*0.8, y: -10, z: 5 }, 
                l_ischium:          { x: -w*0.5, y: -25, z: -5 },
                l_pubis:            { x: -w*0.2, y: -18, z: 12 },
                r_iliac_crest_post: { x: w*0.4, y: 10, z: -5 },
                r_iliac_crest_lat:  { x: w, y: 8, z: 5 },
                r_asis:             { x: w*0.7, y: 0, z: 15 },
                r_acetabulum:       { x: w*0.8, y: -10, z: 5 },
                r_ischium:          { x: w*0.5, y: -25, z: -5 },
                r_pubis:            { x: w*0.2, y: -18, z: 12 },
                pubic_sym:          { x: 0, y: -18, z: 12 }
            };
        }


        // --- 3D BEZIER FOR SPINE ---
        function getBezierPoint3D(t, p0, p1, p2, p3) {
            const mt = 1 - t;
            const mt2 = mt * mt; const mt3 = mt2 * mt;
            const t2 = t * t; const t3 = t2 * t;
            const f0 = mt3; const f1 = 3 * mt2 * t;
            const f2 = 3 * mt * t2; const f3 = t3;
            return {
                x: f0*p0.x + f1*p1.x + f2*p2.x + f3*p3.x,
                y: f0*p0.y + f1*p1.y + f2*p2.y + f3*p3.y,
                z: f0*p0.z + f1*p1.z + f2*p2.z + f3*p3.z
            };
        }


        // --- MAIN CALCULATION ---
        function calculateFrame() {
            // 1. Base Mechanics
            const maxAnkleDeg = 25;
            const ankleRad = maxAnkleDeg * (Math.PI/180) * state.depth;
            const sideKneeZ = Math.sin(ankleRad) * BONE_LENS.tibia;
            const sideKneeY = Math.cos(ankleRad) * BONE_LENS.tibia;
            
            const maxFemurRot = Math.PI * 0.75;
            const femurRad = state.depth * maxFemurRot;
            const sideHipZ = sideKneeZ - Math.sin(femurRad) * BONE_LENS.femur;
            const sideHipY = sideKneeY + Math.cos(femurRad) * BONE_LENS.femur;


            // Torso
            let dx = -sideHipZ;
            let torsoH = Math.sqrt(Math.pow(BONE_LENS.torso, 2) - dx*dx) || BONE_LENS.torso;
            const sideShoulderY = sideHipY + torsoH;
            const leanAngleDeg = Math.atan2(dx, torsoH) * (180/Math.PI);
            const hipAngle = 180 - (femurRad*180/Math.PI) - leanAngleDeg;


            // 2. Pelvic Transform
            let buttWink = 0;
            if(hipAngle < 40) buttWink = (40 - hipAngle) * -1.5;
            if(state.scenario === 'butt_wink') buttWink = -25 * state.depth;


            const tTilt = state.tilt + buttWink;
            const tHike = state.hike;
            const tRot = state.rot;


            const rawPelvis = getRealisticPelvisGeo();
            const transformedPelvis = {};
            const localHipCenter = { x: 0, y: -10, z: 5 };
            const worldHipCenter = { x: 0, y: sideHipY, z: sideHipZ };


            for (let key in rawPelvis) {
                let p = rawPelvis[key];
                p = { x: p.x - localHipCenter.x, y: p.y - localHipCenter.y, z: p.z - localHipCenter.z };
                p = rotateY(p, tRot);
                p = rotateZ(p, tHike);
                p = rotateX(p, tTilt);
                p = rotateX(p, leanAngleDeg);
                p = translate(p, worldHipCenter);
                transformedPelvis[key] = p;
            }


            // 3. Spine
            const sacrumPos = transformedPelvis.sacrum_base;
            const t1Pos = {
                x: 0,
                y: sideShoulderY, 
                z: worldHipCenter.z + (Math.sin(leanAngleDeg * Math.PI/180) * BONE_LENS.torso)
            };
            // Fix T1 Y to match arc
            t1Pos.y = worldHipCenter.y + (Math.cos(leanAngleDeg * Math.PI/180) * BONE_LENS.torso);


            let sacrumUp = { x: 0, y: 1, z: 0 };
            sacrumUp = rotateY(sacrumUp, tRot);
            sacrumUp = rotateZ(sacrumUp, tHike);
            sacrumUp = rotateX(sacrumUp, tTilt);
            sacrumUp = rotateX(sacrumUp, leanAngleDeg);
            
            const cp1Len = BONE_LENS.torso * 0.4;
            const cp1 = {
                x: sacrumPos.x + sacrumUp.x * cp1Len,
                y: sacrumPos.y + sacrumUp.y * cp1Len,
                z: sacrumPos.z + sacrumUp.z * cp1Len
            };


            let t1Down = { 
                x: 0, 
                y: -Math.cos(leanAngleDeg * Math.PI/180), 
                z: -Math.sin(leanAngleDeg * Math.PI/180) 
            };
            const cp2Len = BONE_LENS.torso * 0.4;
            const cp2 = {
                x: t1Pos.x - t1Down.x * cp2Len, 
                y: t1Pos.y + t1Down.y * cp2Len,
                z: t1Pos.z + t1Down.z * cp2Len
            };


            const spine = [];
            for(let i=0; i<=17; i++) spine.push(getBezierPoint3D(i/17, sacrumPos, cp1, cp2, t1Pos));


            // 4. Legs
            const halfStance = state.stance / 2;
            const toeRad = state.toeOut * Math.PI / 180;
            const ankles = { L: { x: -halfStance, y: 0, z: 0 }, R: { x: halfStance, y: 0, z: 0 } };
            const hips = { L: transformedPelvis.l_acetabulum, R: transformedPelvis.r_acetabulum };
            const knees = {};
            ['L', 'R'].forEach(side => {
                const dir = side==='L' ? -1 : 1;
                const kX = ankles[side].x + (Math.sin(toeRad) * sideKneeZ * 1.2 * dir);
                knees[side] = { x: kX, y: sideKneeY, z: sideKneeZ };
            });


            return {
                pelvis: transformedPelvis,
                spine: spine,
                ankles, knees, hips,
                t1: t1Pos,
                meta: {
                    lean: Math.round(leanAngleDeg),
                    hipAngle: Math.round(hipAngle),
                    status: `T:${Math.round(tTilt)} H:${Math.round(tHike)} R:${Math.round(tRot)}`
                }
            };
        }


        // --- DRAWING ---
        function draw() {
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            const data = calculateFrame();
            
            displays.torso.innerText = data.meta.lean + "Â°";
            displays.hip.innerText = data.meta.hipAngle + "Â°";
            displays.pStatus.innerText = data.meta.status;


            let analysis = "";
            if (Math.abs(state.hike) > 5) analysis = "ğŸŸ  **è„Šæ¤å´å½ä»£å„Ÿ**ï¼šéª¨ç›†é«˜ä½å°è‡´è„Šæ¤å¿…é ˆå´å½(Så‹)ä»¥ç¶­æŒé ­éƒ¨é‡å¿ƒå¹³è¡¡ã€‚";
            else if (Math.abs(state.rot) > 5) analysis = "ğŸŸ  **è„Šæ¤æ‰­è½‰**ï¼šéª¨ç›†æ—‹è½‰å°è‡´è…°æ¤ç”¢ç”Ÿæ‰­åŠ›ï¼Œé€™å¸¸æ˜¯å–®é‚Šè…°ç—›çš„ä¸»å› ã€‚";
            else if (state.tilt < -10) analysis = "ğŸ”´ **è…°æ¤å±ˆæ›²**ï¼šéª¨ç›†å¾Œå‚¾å°è‡´è…°æ¤å‰å‡¸æ¶ˆå¤±ï¼Œæ¤é–“ç›¤å£“åŠ›æ¥µå¤§ã€‚";
            else analysis = "éª¨ç›†èˆ‡è„Šæ¤æ’åˆ—è‰¯å¥½ã€‚è©¦è‘—æ—‹è½‰è¦–è§’è§€å¯Ÿè„Šæ¤æ¯ä¸€ç¯€çš„æ’åˆ—ã€‚";
            displays.analysis.innerHTML = analysis;


            draw2D(data, w * 0.25, h);
            draw3D(data, w * 0.625, h);


            ctx.beginPath(); ctx.moveTo(w*0.25, 20); ctx.lineTo(w*0.25, h-20);
            ctx.strokeStyle = "#4b5563"; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
        }


        function draw2D(data, cx, h) {
            const scale = 1.5;
            const ground = h * 0.85;
            const map = (z, y) => ({ x: cx + z * scale, y: ground - y * scale });


            ctx.strokeStyle = "#4b5563"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(cx-50, ground); ctx.lineTo(cx+100, ground); ctx.stroke();


            ctx.strokeStyle = "#a855f7"; ctx.lineWidth = 5;
            ctx.beginPath();
            data.spine.forEach((p, i) => {
                const pt = map(p.z, p.y);
                if(i===0) ctx.moveTo(pt.x, pt.y); else ctx.lineTo(pt.x, pt.y);
            });
            ctx.stroke();


            const hip = map(data.hips.L.z, data.hips.L.y);
            const knee = map(data.knees.L.z, data.knees.L.y);
            const ankle = map(data.ankles.L.z, data.ankles.L.y);
            
            ctx.strokeStyle = "#3b82f6"; ctx.lineWidth = 6;
            ctx.beginPath(); ctx.moveTo(hip.x, hip.y); ctx.lineTo(knee.x, knee.y); ctx.stroke();
            ctx.strokeStyle = "#f97316";
            ctx.beginPath(); ctx.moveTo(knee.x, knee.y); ctx.lineTo(ankle.x, ankle.y); ctx.stroke();
        }


        function draw3D(data, cx, h) {
            const scale = 3.5;
            const ground = h * 0.7;
            const camX = state.cameraAngle.y; 
            const camY = state.cameraAngle.x;


            const project = (p) => {
                const centerY = 50;
                let x = p.x, y = p.y - centerY, z = p.z;
                let p1 = rotateY({x,y,z}, camY);
                p1 = rotateX(p1, camX);
                const fov = 500; const dist = 600;
                const s = fov / (dist - p1.z);
                return { x: cx + p1.x * scale * s, y: ground - (p1.y + centerY) * scale * s, z: p1.z };
            };


            ctx.strokeStyle = "#374151"; ctx.lineWidth = 1;
            for(let i=-100; i<=100; i+=50) {
                const p1 = project({x:i,y:0,z:-100}), p2 = project({x:i,y:0,z:100});
                ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
                const p3 = project({x:-100,y:0,z:i}), p4 = project({x:100,y:0,z:i});
                ctx.beginPath(); ctx.moveTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y); ctx.stroke();
            }


            const p = {};
            for(let k in data.pelvis) p[k] = project(data.pelvis[k]);
            
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#ec4899";
            ctx.fillStyle = "rgba(236, 72, 153, 0.4)";


            // Left Ilium
            ctx.beginPath();
            ctx.moveTo(p.sacrum_base.x, p.sacrum_base.y);
            ctx.lineTo(p.l_iliac_crest_post.x, p.l_iliac_crest_post.y);
            ctx.lineTo(p.l_iliac_crest_lat.x, p.l_iliac_crest_lat.y);
            ctx.lineTo(p.l_asis.x, p.l_asis.y);
            ctx.lineTo(p.l_acetabulum.x, p.l_acetabulum.y);
            ctx.lineTo(p.l_pubis.x, p.l_pubis.y);
            ctx.lineTo(p.pubic_sym.x, p.pubic_sym.y);
            ctx.lineTo(p.l_ischium.x, p.l_ischium.y);
            ctx.lineTo(p.sacrum_tip.x, p.sacrum_tip.y);
            ctx.lineTo(p.sacrum_base.x, p.sacrum_base.y);
            ctx.fill(); ctx.stroke();


            // Right Ilium
            ctx.beginPath();
            ctx.moveTo(p.sacrum_base.x, p.sacrum_base.y);
            ctx.lineTo(p.r_iliac_crest_post.x, p.r_iliac_crest_post.y);
            ctx.lineTo(p.r_iliac_crest_lat.x, p.r_iliac_crest_lat.y);
            ctx.lineTo(p.r_asis.x, p.r_asis.y);
            ctx.lineTo(p.r_acetabulum.x, p.r_acetabulum.y);
            ctx.lineTo(p.r_pubis.x, p.r_pubis.y);
            ctx.lineTo(p.pubic_sym.x, p.pubic_sym.y);
            ctx.lineTo(p.r_ischium.x, p.r_ischium.y);
            ctx.lineTo(p.sacrum_tip.x, p.sacrum_tip.y);
            ctx.lineTo(p.sacrum_base.x, p.sacrum_base.y);
            ctx.fill(); ctx.stroke();
            
            ctx.fillStyle = "rgba(236, 72, 153, 0.7)";
            ctx.beginPath();
            ctx.moveTo(p.sacrum_base.x, p.sacrum_base.y);
            ctx.lineTo(p.l_iliac_crest_post.x, p.l_iliac_crest_post.y);
            ctx.lineTo(p.sacrum_tip.x, p.sacrum_tip.y);
            ctx.lineTo(p.r_iliac_crest_post.x, p.r_iliac_crest_post.y);
            ctx.fill();


            data.spine.forEach((v, i) => {
                const vp = project(v);
                const size = i < 5 ? 5 : 4; 
                ctx.fillStyle = i < 5 ? "#a855f7" : "#8b5cf6"; 
                ctx.strokeStyle = "#e9d5ff";
                ctx.beginPath();
                ctx.rect(vp.x - size, vp.y - size/2, size*2, size);
                ctx.fill(); ctx.stroke();
            });


            ['L', 'R'].forEach(s => {
                const a = project(data.ankles[s]);
                const k = project(data.knees[s]);
                const h = project(data.hips[s]);


                ctx.strokeStyle = "#3b82f6"; ctx.lineWidth = 6;
                ctx.beginPath(); ctx.moveTo(h.x, h.y); ctx.lineTo(k.x, k.y); ctx.stroke();
                ctx.strokeStyle = "#f97316";
                ctx.beginPath(); ctx.moveTo(k.x, k.y); ctx.lineTo(a.x, a.y); ctx.stroke();
                
                ctx.fillStyle = "white";
                ctx.beginPath(); ctx.arc(k.x, k.y, 4, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(a.x, a.y, 4, 0, Math.PI*2); ctx.fill();
            });
            
            const t1 = project(data.t1);
            ctx.fillStyle = "#e5e7eb";
            ctx.beginPath(); ctx.arc(t1.x, t1.y - 15, 12, 0, Math.PI*2); ctx.fill();
        }


        // --- SNAPSHOT FUNCTION ---
        function saveSnapshot() {
            const link = document.createElement('a');
            link.download = 'squat_model_3d_snapshot.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }


        // --- EVENTS ---
        canvas.addEventListener('mousedown', e => { state.isDragging = true; state.lastMouse = {x:e.clientX, y:e.clientY}; });
        window.addEventListener('mousemove', e => {
            if(!state.isDragging) return;
            state.cameraAngle.x += (e.clientX - state.lastMouse.x)*0.5;
            state.cameraAngle.y = Math.max(-45, Math.min(45, state.cameraAngle.y + (e.clientY - state.lastMouse.y)*0.5));
            state.lastMouse = {x:e.clientX, y:e.clientY};
            draw();
        });
        window.addEventListener('mouseup', () => state.isDragging = false);


        const inputs = ['depth', 'tilt', 'hike', 'rot', 'stance', 'toeOut'];
        inputs.forEach(k => els[k] && els[k].addEventListener('input', e => {
            state[k] = parseFloat(e.target.value);
            if(k==='depth') state.depth = e.target.value/100;
            draw();
        }));
        els.resetPelvis.addEventListener('click', () => {
            state.tilt=0; state.hike=0; state.rot=0;
            els.tilt.value=0; els.hike.value=0; els.rot.value=0;
            draw();
        });
        els.scenario.addEventListener('change', e => {
            state.scenario = e.target.value;
            if(state.scenario === 'apt') { state.tilt = 20; els.tilt.value = 20; }
            else if(state.scenario === 'shift') { state.hike = 10; els.hike.value = 10; }
            else if(state.scenario === 'twist') { state.rot = 15; els.rot.value = 15; }
            else { state.tilt=0; state.hike=0; state.rot=0; els.tilt.value=0; els.hike.value=0; els.rot.value=0; }
            draw();
        });


        function resize() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; draw(); }
        window.addEventListener('resize', resize);
        resize();


    </script>
</body>
</html>
